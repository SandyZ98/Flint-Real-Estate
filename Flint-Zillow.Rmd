---
title: "Real estate values and the Flint water crisis"
author: "Ilse Paniagua"
date: "9/9/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include=FALSE}
#install.packages("ZillowR")
#install.packages("censusapi")
library(ZillowR)
library(censusapi)
library(tidyverse)
```

https://www.zillow.com/howto/api/GetChart.htm

XX days on Zillow
Price
Current rates per loan type
GetZestimate22

# Gathering Flint Census data (2010-2017)

```{r}
cs_key <- "99821ff046ee033b7b76cbae65f421bf9136217f"
```

References:
https://hrecht.github.io/censusapi/articles/getting-started.html

https://datausa.io/profile/geo/flint-mi/

```{r Available data census}

apis <- listCensusApis()
View(apis)

#We are interested in the American Community Survey 5-Year Data (2009-2017), name= acs/acs5

```

Metadata information from the American Community Survey 5-Year Data (2009-2017).

```{r}
#5 year detailed tables

ac5_vars <- listCensusMetadata(name = "acs/acs5", vintage=2017,
    type = "variables")

ac5_geo <- listCensusMetadata(name = "acs/acs5", vintage=2017,
    type = "geographies")

```
From the tables above we obtain the variables of interest:

```{r}
myvars <- c("B19001B_001E","B19001A_001E","B01001B_017E","B01001B_002E","B01001B_001E","B01001A_001E","B01001_003E","B01001A_017E","B01001_027E","B01001_003E","B11016_002E","B11016_001E","B25107_001E")
```

Totals:

B19001B_001E: income for black households
B19001A_001E: income for white households
B01001B_017E: total female (black)
B01001B_002E: total male (black)
B01001B_001E: total black
B01001A_001E: total white
B01001_003E: total male (white)
B01001A_017E: total female (white)
B01001_027E: female under 5 years
B01001_003E: male under 5 years
B11016_002E: family households (note: need to calculate proportion of family HH)
B11016_001E: total number of households
B25107_001E: median home value

B25034_010E: built 1940-1949
B25034_009E: built 1950-1959
B25034_008E: built 1960-1969
B25034_007E: built 1970-1979
B25034_006E: built 1980-1989
B25034_005E: built 1990-1999
B25034_004E: built 2000-2009

The state of Michigan is 026, and Genessee county is 049.

```{r}
#5 year detailed tables

#Variables that are only needed once (municipality names and housing structure age)

flint_strage <- getCensus(name = "acs/acs5", vintage = 2010,
vars = c("NAME","B25034_010E","B25034_009E","B25034_008E","B25034_007E","B25034_006E","B25034_005E","B25034_004E"),
region = "tract:*", regionin = "state:26+county:049", key = cs_key )

colnames(flint_strage) <- c("state","county","tract","desc","built_1940-1949","built_1950-1959","built_1960-1969","built_1970-1979","built_1980-1989","built_1990-1999","built_2000-2009")

glimpse(flint_strage)
```

Now we gather data for the years 2011-2017 for the variables that would change from year to year.
```{r}
#Loop for years 2010-2017
flint_acs5 <- matrix()

years <- c("2010","2011","2012","2013","2014","2015","2016","2017")

for(i in years){

flint_partial <- getCensus(name = "acs/acs5", vintage = i,
vars = myvars,
region = "tract:*", regionin = "state:26+county:049", key = cs_key )

colnames(flint_partial) <-c("state","county","tract","income_black","income_white","f_black","m_black","black","white","m_white","f_white","f_under5","m_under5","fam_hh","hh","homevalue")

#Male under 5: B18101_003E

flint_acs5 <- cbind(flint_acs5,flint_partial)
}

```

# Data Cleaning

We have 129 columns, some of which repeat across years. 

```{r Changing variable names}

#Removing empty first column
flint_acs5_clean <- flint_acs5[,2:129]

#Removing multiple cases of state and municipality ID
flint_acs5_clean <- flint_acs5_clean %>% select(-matches("state*|county*|tract*|desc*"))

#Adding years

#.1 = 2011, .2=2012.....7=2017

nums <- c(1,2,3,4,5,6,7)

for(col in colnames(flint_acs5_clean)){
  for(i in nums){
    colnames(flint_acs5_clean)[colnames(flint_acs5_clean) == col] <- gsub(paste("\\.", nums[i], sep = ""), paste("_201", nums[i], sep = ""), col)
  }
}

#THIS IS WHERE I LEFT Off
#Changing name of 2010 (col 1:13)

colnames(flint_acs5_clean)[1:13] <- paste(colnames(flint_acs5_clean[1:13]), "_2010",sep="")


#Adding structure age data
flint_acs5_clean <- cbind(flint_strage,flint_acs5_clean)

```

Now we will keep only the census tracts that are inside of Flint.

The census tracts of interest (39, obtained from Census website) are: 000100,001000,001100,001200,011713,013500,013600,001400,001500,001600,001700,001800,001900,000200,002000,002200,002300,002400,002600,002700, 002800,002900,000300,003000,003100,003200,003300,003400,003500,003600,003700,003800,000400,004000,000500,000600,000700,000800,000900

```{r}
#Keeping only tracts of interest
tracts <- c(100,001000,001100,001200,011713,013500,013600,001400,001500,001600,001700,001800,001900,000200,002000,002200,002300,002400,002600,002700, 002800,002900,000300,003000,003100,003200,003300,003400,003500,003600,003700,003800,000400,004000,000500,000600,000700,000800,000900)

flint_acs5_clean <- flint_acs5_clean %>% filter(tract %in% tracts)
```

# Restructure into tidy data

```{r}

```



# Data Exploration

* Trends in income over time, by race and gender

* Trends in number of households over time

* Trends in housing values over time, by race

* Number of children under 5

Are there differences in tracts that had lead pipes?
