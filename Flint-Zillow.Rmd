---
title: "Real estate values and the Flint water crisis"
author: "Ilse Paniagua and Zeping Tao"
date: "9/9/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include=FALSE}
#install.packages("ZillowR")
#install.packages("censusapi")
library(ZillowR)
library(censusapi)
library(tidyverse)
library(foreign)
library(XML)
```

https://www.zillow.com/howto/api/GetChart.htm

XX days on Zillow
Price
Current rates per loan type
GetZestimate22

# Gathering Flint Census data (2010-2017)

```{r}
cs_key <- "99821ff046ee033b7b76cbae65f421bf9136217f"
```

References:
https://hrecht.github.io/censusapi/articles/getting-started.html

https://datausa.io/profile/geo/flint-mi/

```{r Available data census}

apis <- listCensusApis()
View(apis)

#We are interested in the American Community Survey 5-Year Data (2009-2017), name= acs/acs5

```

Metadata information from the American Community Survey 5-Year Data (2009-2017).

```{r}
#5 year detailed tables

ac5_vars <- listCensusMetadata(name = "acs/acs5", vintage=2017,
    type = "variables")

ac5_geo <- listCensusMetadata(name = "acs/acs5", vintage=2017,
    type = "geographies")

```
From the tables above we obtain the variables of interest:

```{r}
myvars <- c("B19001B_001E","B19001A_001E","B01001B_017E","B01001B_002E","B01001B_001E","B01001A_001E","B01001A_002E","B01001A_017E","B01001_027E","B01001_003E","B11016_002E","B11016_001E","B25107_001E")
```

Totals:

B19001B_001E: income for black households
B19001A_001E: income for white households
B01001B_017E: total female (black)
B01001B_002E: total male (black)
B01001B_001E: total black
B01001A_001E: total white
B01001A_002E: total male (white)
B01001A_017E: total female (white)
B01001_027E: female under 5 years
B01001_003E: male under 5 years
B11016_002E: family households (note: need to calculate proportion of family HH)
B11016_001E: total number of households
B25107_001E: median home value

B25034_010E: built 1940-1949
B25034_009E: built 1950-1959
B25034_008E: built 1960-1969
B25034_007E: built 1970-1979
B25034_006E: built 1980-1989
B25034_005E: built 1990-1999
B25034_004E: built 2000-2009

The state of Michigan is 026, and Genessee county is 049.

```{r}
#5 year detailed tables

#Variables that are only needed once (municipality names and housing structure age)

flint_strage <- getCensus(name = "acs/acs5", vintage = 2010,
vars = c("NAME","B25034_010E","B25034_009E","B25034_008E","B25034_007E","B25034_006E","B25034_005E","B25034_004E"),
region = "tract:*", regionin = "state:26+county:049", key = cs_key )

colnames(flint_strage) <- c("state","county","tract","desc","1940-1949","1950-1959","1960-1969","1970-1979","1980-1989","1990-1999","2000-2009")

glimpse(flint_strage)
```

Now we gather data for the years 2011-2017 for the variables that would change from year to year.
```{r}
#Loop for years 2010-2017
flint_acs5 <- matrix()

years <- c("2010","2011","2012","2013","2014","2015","2016","2017")

for(i in years){

flint_partial <- getCensus(name = "acs/acs5", vintage = i,
vars = myvars,
region = "tract:*", regionin = "state:26+county:049", key = cs_key )

colnames(flint_partial) <-c("state","county","tract","income_black","income_white","f_black","m_black","black","white","m_white","f_white","f_under5","m_under5","fam_hh","hh","homevalue")

#Male under 5: B18101_003E

flint_acs5 <- cbind(flint_acs5,flint_partial)
}

```

# Data Cleaning

We have 129 columns, some of which repeat across years. This step will help us organize variables for reshaping and will add clarity to variable names.

```{r Changing variable names}

#Removing empty first column
flint_acs5_clean <- flint_acs5[,2:129]

#Removing multiple cases of state and municipality ID
flint_acs5_clean <- flint_acs5_clean %>% select(-matches("state*|county*|tract*|desc*"))

#Adding years

#.1 = 2011, .2=2012.....7=2017

nums <- c(1,2,3,4,5,6,7)

for(col in colnames(flint_acs5_clean)){
  for(i in nums){
    colnames(flint_acs5_clean)[colnames(flint_acs5_clean) == col] <- gsub(paste("\\.", nums[i], sep = ""), paste("_201", nums[i], sep = ""), col)
  }
}

#Changing name of 2010 (col 1:13)

colnames(flint_acs5_clean)[1:13] <- paste(colnames(flint_acs5_clean[1:13]), "_2010",sep="")


#Adding structure age data
flint_acs5_clean <- cbind(flint_strage,flint_acs5_clean)

```

Now we will keep only the census tracts that are inside of Flint.

The census tracts of interest (39, obtained from Census website) are: 000100,001000,001100,001200,011713,013500,013600,001400,001500,001600,001700,001800,001900,000200,002000,002200,002300,002400,002600,002700, 002800,002900,000300,003000,003100,003200,003300,003400,003500,003600,003700,003800,000400,004000,000500,000600,000700,000800,000900

```{r}
#Keeping only tracts of interest
tracts <- (c(000100,001000,001100,001200,011713,013500,013600,001400,001500,001600,001700,001800,001900,000200,002000,002200,002300,002400,002600,002700, 002800,002900,000300,003000,003100,003200,003300,003400,003500,003600,003700,003800,000400,004000,000500,000600,000700,000800,000900))

#Full data
flint_acs5_clean$tract <- as.numeric(flint_acs5_clean$tract)

flint_acs5_clean <- flint_acs5_clean %>% filter(tract %in% tracts)

#Structure age data
flint_strage$tract <- as.numeric(flint_strage$tract)

flint_strage <- flint_strage %>% filter(tract %in% tracts)
```

# Restructure into tidy data

```{r}
#Gathering data

#Full dataset
flint_acs5_clean <- flint_acs5_clean %>% gather(5:11,key = "built", value = "cases") %>% arrange(.,tract)

#Structure age data
flint_strage <- flint_strage %>% gather(5:11,key = "built", value = "cases") %>% arrange(.,tract)

#Creating year variable

flint_acs5_clean <- flint_acs5_clean  %>% select(noquote(order(colnames(.)))) %>% select(state,county,tract,desc,built,cases,everything())

#Reshaping data columns 7-110

acs_vars <- c("income_black","income_white","f_black","m_black","black","white","m_white","f_white","f_under5","m_under5","fam_hh","hh","homevalue") %>% sort(decreasing=FALSE)

flint_acs5_clean_full <- flint_acs5_clean %>% 
  reshape(
  idvar=c("tract","built"),
  varying=list(c(7:14),c(15:22),c(23:30),c(31:38),c(39:46),c(47:54),c(55:62),   c(63:70),c(71:78),c(79:86),c(87:94),c(95:102),c(103:110)), 
  v.names=acs_vars, 
  timevar="year", 
  times=years, 
  direction="long") %>% arrange(.,tract)

glimpse(flint_acs5_clean_full)
```

Now we create a dataset with only one row per tract and year.

```{r}
#Dataset that doesn't include structure age

flint_acs5_series <- flint_acs5_clean_full %>% select(-built,-cases) %>% unique.data.frame()

glimpse(flint_acs5_series)

```

We now have three tidy datasets:

1. Housing structure age by tract (273 rows= 39 tracts* 7 structure age)
2. Demographic variables and housing structure by tract (2,184 rows= 39 tracts* 7 structure age * 8 years)
3. Demographic variables by tract (312 rows= 39 tracts * 8 years)

# Data Exploration

* Age of housing structures, by tract

Calcualte the total number of houses per tract. Then, calculate what percentage belong to each category, per tract. Aggregate the results in a bar chart for each age group.

<<<<<<< HEAD
flint_strage %>% arrange
=======
```{r}
#Summary table, number of cases in each category
>>>>>>> 730d0cfd723723d5bba365e6adfa932a760a6036

flint_strage %>% group_by(tract) %>% mutate(numhouses=sum(cases)) %>% group_by(built,tract) %>% summarise(mean=cases/numhouses) %>% group_by(built) %>% summarise(proportion=mean(mean)) %>% ggplot(.,aes(built,proportion)) + geom_col()
                                    
```

Flint has a large proportion of old homes built between 1940-49, followed by homes built between 1960-69.

* Population trends over time

```{r}
flint_acs5_series$year <-  flint_acs5_series$year %>% as.numeric()
```


```{r}
#Adult males and females, overall
flint_acs5_series %>% gather(6,8:10,15:18,key = "type", value = "population") %>% arrange(.,tract) %>% filter(type %in% c("black","white","type","population")) %>% group_by(year, type) %>% summarise(mean=mean(population)) %>% ggplot(aes(x=year, y=mean)) + geom_area(aes(fill=type))

#Adult males and females, by race
flint_acs5_series %>% gather(6,8:10,15:18,key = "type", value = "population") %>% arrange(.,tract) %>% filter(type %in% c("m_white","f_white","f_black","m_black","type","population")) %>% group_by(year, type) %>% summarise(mean=mean(population)) %>% ggplot(aes(x=year, y=mean)) + geom_area(aes(fill=type))
```
Population trends seem steady over time. The white population seems to have increased after 2017. This, combined with rising house prices in 2017, may point to some gentrification.


* Trends in income over time, by race and gender

```{r}
#Income variable
flint_acs5_series %>% gather(13:14,key = "race", value = "income") %>% arrange(.,tract) %>% group_by(year, race) %>% summarise(mean=mean(income)) %>% ggplot(aes(x=year, y=mean)) + geom_point(aes(fill=race))

```

* Number of children under 5

<<<<<<< HEAD
Are there differences in tracts that had lead pipes?

=======
```{r}
#Children variable

flint_acs5_series %>% gather(6,8:10,15:18,key = "type", value = "population") %>% arrange(.,tract) %>% filter(type %in% c("m_under5","f_under5","type","population")) %>% group_by(year, type) %>% summarise(mean=mean(population)) %>% ggplot(aes(x=year, y=mean)) + geom_line(aes(color=type))

```

The average numer of children per tract declined slightly between 2013 and 2016.

* Trends in housing values over time

```{r}
#Housing values over time

flint_acs5_series$year <- flint_acs5_series$year %>% as.character()

flint_acs5_series %>% ggplot(., aes(x=year, y=homevalue)) + geom_point() + geom_boxplot()
```

Are there differences in tracts that had lead pipes?
>>>>>>> 730d0cfd723723d5bba365e6adfa932a760a6036

# Gather Zillow data 
"ZillowR" package provides funtions to call Zillow api to get its property data. However, it only allows specific addresses as input parameter. Therefore, we need to get all the addresses in Flint. Fortunately, TIGER/Line Shapefile provides the information that allows us to make up all the potential addresses in Flint and try them with Zillow api.

First, we load the address ranges from "Address Ranges County-based Relationship File", which contains "Address range identifier"(ARID). Then we load the feature names (street names) from "Feature Names County-based Relationship File", which contains "Linear feature identifier"(LINEARID). Third, we load "Address Range-Feature Name County-based Relationship File" that describe the match between ARID and LINEARID. 
```{r}
table_range<-read.dbf("Genesee County Address Range/tl_2019_26049_addr.dbf",as.is = TRUE)
table_names<-read.dbf("Genesee County Feature Names/tl_2019_26049_featnames.dbf",as.is=TRUE)
table_relat<-read.dbf("Genesee County Relationship File/tl_2019_26049_addrfn.dbf",as.is=TRUE)

length(unique(table_names$LINEARID))
nrow(unique(table_names))
length(unique(table_range$ARID))

table_ID <- merge(table_range,table_relat,by="ARID")
keep<-c("ARID","LINEARID","FROMHN","TOHN","ZIP")
table_ID <-na.omit(table_ID[keep])
table_address <- merge(table_ID,unique(table_names[c("FULLNAME","LINEARID")]),by="LINEARID")

table_address$FROMHN<-as.numeric(table_address$FROMHN)
table_address$TOHN<-as.numeric(table_address$TOHN)
nrow(table_address[is.na(table_address$FROMHN),])
keep2<-c("FULLNAME","FROMHN","TOHN","ZIP")
table_addr_clean<-na.omit(unique(table_address[keep2]))

saveRDS(table_addr_clean,"Address Frame.RData")
source("Zillow API request loop.R")

```